/*
 * fats init command
 * */
require("date-format-lite");
var fs = require('fs');
var path = require('path');
exports.name = 'init';
exports.usage = '[options]';
exports.desc = 'initialization project by template';
exports.register = function (commander) {

	var projectName, hasBranches, template,
		fats = require('fats-kernel'),
		root = process.cwd(),
		inquirer = require('inquirer');


	// output version info
	var first = process.argv[3];
	if (first === '-v' || first === '--version') {
		fats.util.version(__dirname + '/package.json');
		process.exit(0);
	}


	var yesOrNoArr = ['yes', 'no'];
	var templateArr = ['default'], tplDir = path.dirname(path.dirname(require.main.filename)) + '/lib/templates';

	//read custom template
	fs.readdir(tplDir, function (err, paths) {
		paths.forEach(function (path) {
			var _src = tplDir + '/' + path;
			fs.stat(_src, function (err, st) {
				if (err) {
					throw err;
				}
				if (st.isDirectory() && !fats.util.inArray(path, templateArr)) {
					templateArr.push(path);
				}
			});
		})
	});

	// init custom info
	function initPrompt() {
		inquirer.prompt([
			{
				type: 'input',
				name: 'name',
				default: 'demo',
				message: 'Project name',
				validate: function (val) {
					var done = this.async();
					var targetDir = root + '/' + val;
					var exists = fs.existsSync(targetDir);
					// Do async stuff
					setTimeout(function () {
						if (/[^0-9a-z\-\_]/i.test(val)) {
							done("Can contain only letters, digits, hyphen, and underline, input again");
							return;
						} else if (exists) {
							// Pass the return value in the done callback
							done("Folder already exists, input again");
							return;
						}
						// Pass the return value in the done callback
						done(true);
					}, 600);
				}
			},
			{
				type: 'input',
				name: 'branches',
				choices: yesOrNoArr,
				default: 'no',
				validate: function (val) {
					return fats.util.inArray(val, yesOrNoArr);
				},
				message: 'Has branches [' + yesOrNoArr.join('/') + ']?'
			},
			{
				type: 'list',
				name: 'template',
				choices: templateArr,
				default: 'default',
				validate: function (val) {
					return fats.util.inArray(val, templateArr);
				},
				message: 'Template'
			}
		], function (opts) {
			fats.util.extend(opts, {root: root});
			initAction(opts);
		})
	}

	// quick init
	function quickInit(val) {
		var targetDir = root + '/' + val;
		var exists = fs.existsSync(targetDir);
		if (/[^0-9a-z\-\_]/i.test(val)) {
			fats.log.warning("Can contain only letters, digits, hyphen, and underline, input again");
			process.exit(0);
		} else if (exists) {
			// Pass the return value in the done callback
			fats.log.warning("Folder already exists, input again");
			process.exit(0);
		}

		var opts = {
			name: val,
			branches: 'no',
			template: 'default'
		};

		fats.util.extend(opts, {root: root});
		initAction(opts);
	}

	// init action
	function initAction(opts) {
		checkDir(opts);
		addProject(opts);
		writePackage(opts);
	}

	commander.action(function () {
		if (first) {
			quickInit(first);
		} else {
			initPrompt();
		}
	});

	// checkDir
	function checkDir(opts) {
		var targetDir = root + '/' + opts.name;

		// check dir exists
		var exists = fs.existsSync(targetDir);
		if (!exists) {
			fs.mkdirSync(targetDir);
		}
	}

	//write package
	function writePackage(opts) {

		//write packagejson
		var packageJsonXml =
			'{\n'
				+ '\t"name": '
				+ '"' + opts.name + '"'
				+ ",\n"
				+ '\t"version": '
				+ '"0.0.0"'
				+ ",\n"
				+ '\t"branches": '
				+ '"' + opts.branches + '"'
				+ ",\n"
				+ '\t"template": '
				+ '"' + opts.template + '"'
				+ '\n'
				+ '}\n';

		fs.writeFile(root + '/' + opts.name + '/package.json', packageJsonXml, function (err) {
			if (err)
				throw err;
		});

	}

	//path add project
	function addProject(opts) {
		var thisPath = path.dirname(path.dirname(process.argv[1])) + '/lib/templates/' + opts.template;
		var acTionPath = opts.root + "/" + opts.name;
		var appinfo = fats.util.readJSON(path.dirname(path.dirname(__dirname)) + '/package.json');
		// copy files
		var data = {
			name: opts.name,
			APP_NAME: appinfo.name,
			APP_VERSION: appinfo.version,
			CREATE_TIME: fats.util.localDate().format('UTC:YYYY-MM-DD hh:mm:ss'),
			CREATE_DATE: fats.util.localDate().format('UTC:YYYY.MM.DD')
		};
		fats.util.copyDir(thisPath, acTionPath, data);

		/*
		 * 建立 .mock 文件夹
		 * */
		var mockDir = path.join(root, opts.name + '/.mock');
		if (!fats.util.exists(mockDir)) {
			fs.mkdirSync(mockDir);
		}
		// 写入配置文件
		if (!fats.util.exists(mockDir + '/conf.json')) {
			var confStr = [
				'{',
				'\t"cookie": {',
				'\t',
				'},',
				'\t"/mock/test": "./test.js"',
				'}'
			];
			var testJsStr = [
				'This is a test.'
			];
			fs.writeFileSync(mockDir + '/conf.json', confStr.join('\n'));
			fs.writeFileSync(mockDir + '/test.js', testJsStr.join('\n'));
		}

		fats.log.ok('Init success');
	}
};